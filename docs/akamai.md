## Akamai Certificate Provisioning Service

The Akamai Certificate Provisioning Service (CPS) Certificate Store Type is a configuration within Keyfactor Command designed to manage SSL/TLS certificates on the Akamai platform. This Certificate Store Type represents specific collections or individual instances of certificates utilized within the Akamai CPS environment, either in 'Production' or 'Staging'. By defining a Certificate Store, administrators can leverage Keyfactor Command to automate inventory, addition, removal, and discovery of certificates on Akamai's network.

### Purpose

The primary function of the Akamai CPS Certificate Store Type is to enable seamless certificate lifecycle management directly from Keyfactor Command. It simplifies the interaction with Akamai's API by automating certificate operations, ensuring that certificates are always up-to-date and compliant across Akamai's global CDN.

### Representation

Certificate Stores in this context represent managed certificate collections within the Akamai CPS. They map to the various environments relevant for deployment, such as Production or Staging, allowing administrators to maintain a clear structure and process for certificate provisioning and renewal.

### Configuring and SDK Usage

Configuration of the Akamai CPS Certificate Store Type can be achieved through `kfutil`, a utility that simplifies store type creation by handling all necessary Custom Fields and Entry Parameters. If configured manually, administrators must ensure all required parameters are correctly set. The extension does not explicitly mention using a separate SDK, but it interacts with Akamai's API to perform required operations.

### Caveats and Limitations

There are several caveats and potential areas for confusion when using the Akamai CPS Certificate Store Type. One notable limitation is that Akamai does not support traditional certificate renewal or one-click renewal within Keyfactor Command. Instead, the Reenrollment job must be used to renew existing certificates, requiring Akamai to generate the keys on their platform. Also, the API credentials used for authentication should be treated securely, as they act like plaintext passwords.

### Areas of Confusion

Administrators should be aware that the Custom Fields and Entry Parameters required for this Certificate Store Type can be extensive. Proper configuration is crucial for successful operation. It is also important to differentiate between Enrollment ID and Slot ID when performing renewals or reenrollment, as they serve different roles in the certificate lifecycle process.



### Supported Job Types

| Job Name | Supported |
| -------- | --------- |
| Inventory | âœ… |
| Management Add |  |
| Management Remove |  |
| Discovery |  |
| Create |  |
| Reenrollment |  |

## Requirements

### Akamai Platform Configuration

In the Akamai instance, an API Credential needs to be configured and used to provide authentication for the Keyfactor Orchestrator extension to function. To do this, navigate to `Account Admin` -> `Identity & access`. Clicking `Create API client`, select a user whose permissions should be used to access and manage certificates. This user should already have the needed permissions to access CPS. The access of the API Client can be restricted to just the CPS APIs, but the API Client should have `READ-WRITE` access.

With the API Client created, a new credential should be generated by clicking `Create credential`. The contents of the credential should be downloaded or saved temporarily to use for configuring the Keyfactor Certificate Store. Afterwards, it should be deleted as the credential file serves as authentication for accessing APIs, and should be treated as a plaintext password and not saved long-term.

### Akamai Orchestrator Extension Configuration

**1a. Use `kfutil` to create the entire store type definition**

Using `kfutil` to create the store type is the preferred method to create the Akamai store type. It will create all of the needed Custom Fields and Entry parameters (of which there are many).

Creating the store can be done by running the following `kfutil` command:

```
kfutil store-types create -n Akamai
```

If using `kfutil`, skip steps __1b__ and __2__ and go to step __3__ to set the default values of the Entry Parameters.

**1b. Manually Create the New Certificate Store Type for the Akamai orchestrator extension**

In Keyfactor Command create a new Certificate Store Type similar to the one below by clicking Settings (the gear icon in the top right) => Certificate Store Types => Add:

![](images/store-type-basic.png)
![](images/store-type-advanced.png)

Custom fields and entry parameters will be added after the store is created. This is required as there are many entry parameters.

**2. Add Custom Fields and Entry Paramaters**

_Only requried if manually adding the certificate store._
To add the needed Custom Fields and Entry Parameters, [run the script](akamai-cps-orchestrator/jobproperties.sql) on the Keyfactor database to generate all the fields and parameters needed.

**3. Set default values of Entry Parameters**

The Entry Parameters are used during Enrollment creation in Akamai CPS to provide contact information and associate new certificates with the correct Contract in Akamai. After adding the parameters, re-open the Certificate Store Type configuration and set the default values.

The Contract ID should be set to the default contract to be used for new Enrollments. All of the address information should be filled out with default expected values, as they are required fields for **each** enrollment created and should not be entered manually unless they need to be overwritten for a specific Enrollment in Akamai.
The Tech contact information should be your Akamai company contact, and needs to have an Akamai email address and should have Akamai as the organization name.

**4. Create a new Akamai Certificate Store**

After the Certificate Store Type has been configured, a new Akamai Certificate Store can be created. When creating the store, the credentials generated in the Akamai platform for the API Client will be used.

| Certificate Store parameter | Akamai credential value |
|-|-|
| Client Machine | `host` |
| Access Token | `access_token` |
| Client Token | `client_token` |
| Client Secret | `client_secret` |

**5. (Optional) Enroll a new certificate in Akamai**

Adding new certificates to Akamai requires generating a key in Akamai CPS via the Reenrollment process in Keyfactor. To start this process, go to the Certificate Store that the certicate should be added to. Select the certificate store, and click the `Reenrollment` button to bring up the reenrollment dialog.

Change any default values as needed, and enter an Enrollment ID if an existing enrollment needs to be updated instead of creating a new Enrollment. This is different from the Slot ID - the Enrollment ID is found by clicking on an Active certificate in Akamai CPS, and looking at the `ID` value.
The SAN entry needs to be filled out with the DNS value you are using for the certificate's CN. If there are multiple DNS SANs, they should be separted with an ampersand. Example: `www.example01.com&www.example02.com`


**6. (Optional) Configure Renewal of Certificates using Expiration Alert Handler**

Akamai does not support traditional certificate Renewal or one-click Renewal done in the Keyfactor Command platform. The Renewal process creates Certificates with outside keys which are not allowed to be imported into Akamai CPS. As a result, the Reenrollment Job must be used in order to renew existing certificates that reside on the Akamai system. Reenrollment is required as opposed to the Renewal process as it allows Akamai to generate the keys on their platform, which are used to create a certificate in Keyfactor.

Renewing existing certificates in Akamai means running a Reenrollment Job with the same Enrollment ID that was used for an existing Certificate Enrollment. This can be done manually through the Reenrollment process, but an automated process can also be configured using a Keyfactor Expiration Alert Handler.

The Expiration Alert Handler should be configured to target a Keyfactor Collection of certificates that includes the Akamai certificates that need to be renewed. This can be done with a query targeting the `CertStoreFQDN` containing `Akamai` and can be further restricted with the `CertStorePath` being equal to `Production` or `Staging`.

With the Expiration Alert Handler using the correct Collection, the Alert should be set to use the `ExpirationPowershell` Handler. A [sample Powershell Handler script](./akamai-cps-orchestrator/AkamaiExpirationHandler.ps1) is included in this repository. The sample script needs to be updated with the correct URL for API requests, and may need other changes as well, as it assumes that Default Credentials (Windows Auth) can be used to authenticate API requests to the Keyfactor instance. __This script needs to be placed in the Keyfactor Command installation's configured Extension Handler Path (default: {installation_dir}\ExtensionLibrary) location so that it can be run.__

The `ExpirationPowershell` Event Handler configuration should be configured with the following values:

| Parameter Name | Type | Value |
| - | - | - |
| Thumbprint | Special Text | Thumbprint |
| Template | Renewal Template | `desired renewal template` |
| CAConfiguration | Renewal Certificate Authority | `desired renewal CA` |
| ScriptName | PowerShell Script Name | AkamaiExpirationHandler.ps1 |

When running the sample script, it will assume that all certs passed to the script should schedule a Reenrollment job with their existing parameters in Akamai.



## Certificate Store Type Configuration

The recommended method for creating the `Akamai` Certificate Store Type is to use [kfutil](https://github.com/Keyfactor/kfutil). After installing, use the following command to create the `` Certificate Store Type:

```shell
kfutil store-types create Akamai
```

<details><summary>Akamai</summary>

Create a store type called `Akamai` with the attributes in the tables below:

### Basic Tab
| Attribute | Value | Description |
| --------- | ----- | ----- |
| Name | Akamai Certificate Provisioning Service | Display name for the store type (may be customized) |
| Short Name | Akamai | Short display name for the store type |
| Capability | Akamai | Store type name orchestrator will register with. Check the box to allow entry of value |
| Supported Job Types (check the box for each) | Add, Discovery, Remove | Job types the extension supports |
| Supports Add |  |  Indicates that the Store Type supports Management Add |
| Supports Remove |  |  Indicates that the Store Type supports Management Remove |
| Supports Discovery |  |  Indicates that the Store Type supports Discovery |
| Supports Reenrollment |  |  Indicates that the Store Type supports Reenrollment |
| Supports Create |  |  Indicates that the Store Type supports store creation |
| Needs Server |  | Determines if a target server name is required when creating store |
| Blueprint Allowed |  | Determines if store type may be included in an Orchestrator blueprint |
| Uses PowerShell |  | Determines if underlying implementation is PowerShell |
| Requires Store Password |  | Determines if a store password is required when configuring an individual store. |
| Supports Entry Password |  | Determines if an individual entry within a store can have a password. |

The Basic tab should look like this:

![Akamai Basic Tab](../docsource/images/Akamai-basic-store-type-dialog.png)

### Advanced Tab
| Attribute | Value | Description |
| --------- | ----- | ----- |
| Supports Custom Alias | Forbidden | Determines if an individual entry within a store can have a custom Alias. |
| Private Key Handling | Forbidden | This determines if Keyfactor can send the private key associated with a certificate to the store. Required because IIS certificates without private keys would be invalid. |
| PFX Password Style | Default | 'Default' - PFX password is randomly generated, 'Custom' - PFX password may be specified when the enrollment job is created (Requires the Allow Custom Password application setting to be enabled.) |

The Advanced tab should look like this:

![Akamai Advanced Tab](../docsource/images/Akamai-advanced-store-type-dialog.png)

### Custom Fields Tab
Custom fields operate at the certificate store level and are used to control how the orchestrator connects to the remote target server containing the certificate store to be managed. The following custom fields should be added to the store type:

| Name | Display Name | Type | Default Value/Options | Required | Description |
| ---- | ------------ | ---- | --------------------- | -------- | ----------- |


The Custom Fields tab should look like this:

![Akamai Custom Fields Tab](../docsource/images/Akamai-custom-fields-store-type-dialog.png)



</details>

## Certificate Store Configuration

After creating the `Akamai` Certificate Store Type and installing the Akamai Certificate Provisioning System (CPS) Universal Orchestrator extension, you can create new [Certificate Stores](https://software.keyfactor.com/Core-OnPrem/Current/Content/ReferenceGuide/Certificate%20Stores.htm?Highlight=certificate%20store) to manage certificates in the remote platform.

The following table describes the required and optional fields for the `Akamai` certificate store type.

| Attribute | Description | Attribute is PAM Eligible |
| --------- | ----------- | ------------------------- |
| Category | Select "Akamai Certificate Provisioning Service" or the customized certificate store name from the previous step. | |
| Container | Optional container to associate certificate store with. | |
| Client Machine | For the Client Machine field, the user should enter the hostname of the Akamai API endpoint that will be used to manage the certificates. Example: `api.ccu.akamai.com`. | |
| Store Path | For the Store Path field, the user should enter either `Production` or `Staging` to specify the environment where the certificates will be managed within the Akamai platform. | |
| Orchestrator | Select an approved orchestrator capable of managing `Akamai` certificates. Specifically, one with the `Akamai` capability. | |

* **Using kfutil**

    ```shell
    # Generate a CSV template for the AzureApp certificate store
    kfutil stores import generate-template --store-type-name Akamai --outpath Akamai.csv

    # Open the CSV file and fill in the required fields for each certificate store.

    # Import the CSV file to create the certificate stores
    kfutil stores import csv --store-type-name Akamai --file Akamai.csv
    ```

* **Manually with the Command UI**: In Keyfactor Command, navigate to Certificate Stores from the Locations Menu. Click the Add button to create a new Certificate Store using the attributes in the table above.